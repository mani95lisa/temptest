(function(){define(["console","humane","moment"],function(e,t,n){return function(r,i,s,o,u,a,f,l){var c,h,p,d;return e.group("promotion"),c=function(e,t,n,s){getDict(i,e,function(i){n?i&&s?r[n][e]=i[s]:r[n][e]=i:(e==="PMTimes"&&(!i||!i.list.length)?i={list:[{start:"",end:""}]}:e==="PMProducts"&&!i&&(i={list:[]}),r[e]=i);if(i&&t)return t(i)})},d=function(n,s,o,u){var a,f,l;u?f={key:n,list:s}:f=s,f.key=n,a=[],l=!1,f.list.forEach(function(e){if(e.text)return l=!0,a.push(e.text)}),l&&(f.list=a),r.handling=!0,e.log(f),i.post("/dict/update/list",f).success(function(e){return r.handling=!1,e.err?t.log(e.err):(o(!0),t.log("保存成功"))})},p=function(e){if(e.err)return t.log(e.err)},r.tagAdded=function(e){return d(e,r[e],p)},r.tagRemoved=function(e){return d(e,r[e],p)},r.productRemove=function(t){var n;return e.log(t),n=r.PMProducts.list,n.forEach(function(e){e.name===t.text&&n.splice(n.indexOf(e),1)})},r.productAdded=function(t){return e.log(t),h.forEach(function(e){var n;e.name===t.text&&(n=[],e.prices.forEach(function(e){return n.push(e.label+"="+e.value)}),e.price_info=n.join(" "),r.PMProducts.list.push(e))})},c("PMTimes"),c("PMProducts"),c("PMProductNames"),r.addTime=function(){return r.PMTimes.list.push({start:"",end:""})},h=[],r.loadTags=function(e){var t;return t=s.defer(),i.get("/m/product/list",{params:{page:1,pageSize:10,keywords:e}}).success(function(e){var n;return h=e.result,n=[],h&&h.length&&h.forEach(function(e){if(e.name)return n.push(e.name)}),t.resolve(n)}),t.promise},r.getPrices=function(e){var t;return t=[],e&&e.forEach(function(e){return t.push(e.label+"="+e.value)}),t.join(" ")},r.save=function(){var e,i,s;i=r.PMTimes.list,s=!0,e=!0,i.length?i.forEach(function(e){if(!e.start||!e.end)return i.splice(i.indexOf(e),1);if(!n(e.start,"HH:mm").isValid()||!n(e.end,"HH:mm").isValid())s=!1,t.log("时段格式错误，应该是 08:00 或 14:00 这样的")}):s=!1,h=r.PMProducts.list,h.length?h.forEach(function(e){var n,r;if(!!e.price_info)return n=e.price_info.split(" "),r=[],n.forEach(function(e){var n;n=e.split("=");if(n.length===2&&!!parseInt(n[1]))return r.push({label:n[0],value:n[1]});t.log("价格标签格式错误")}),e.prices=r;t.log("价格标签不能为空")}):e=!1,s&&r.tagAdded("PMTimes");if(e)return r.tagAdded("PMProducts"),r.tagAdded("PMProductNames")},e.groupEnd()}})}).call(this);