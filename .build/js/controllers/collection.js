(function(){"use strict";define(["console","humane","moment"],function(e,t,n){return function(r,i,s,o,u,a,f){var l,c;return e.group("collection"),r.page=1,r.search=function(){return r.page=1,r.getData()},r.pageSize=10,r.pages=[10,25,50,100],r.filters=["所有","缓存失败","已缓存完毕"],r.filter={value:"所有"},r.footer="partials/grid/grid_footer.html",r.header="partials/grid/grid_header.html",r.$watch("pageSize",function(e){return r.gridApi&&($("#grid1").height(e*35),r.gridApi.grid.refresh()),r.getData()}),r.$watch("page",function(e){return r.getData()}),r.$watch("filter.value",function(e){return r.getData()}),l=[],u(function(){if(a.path()==="/collection")return r.getData()},6e4),r.requesting=!1,r.externalScopes={edit:function(n){var s;return s=o.open({templateUrl:"modals/edit_collection.html",controller:"EditCollection",backdrop:"static",resolve:{data:function(){return n.entity}}}),s.result.then(function(n){return i.post("/m/collection/update",n).success(function(n){return n.err?(t.error(n.err),r.getData()):(t.log("更新成功"),e.log(n))})},function(){return e.log("dismiss")})},cache:function(e){if(r.requesting)return;r.requesting=!0;if(l.indexOf(e.entity)===-1||e.entity.cache_status==="缓存失败")return i.get("/m/cache",{params:{id:e.entity._id}}).success(function(n){return n.err?t.log(err):n.finished?t.log("已缓存成功"):(e.entity.cache_status="开始缓存",l.push(e.entity),t.log("开始缓存")),r.requesting=!1}).error(function(e){return e&&t.log(e),r.requesting=!1})},check:function(e){var t;return t=JSON.stringify(e.entity),f.setCheck(e.entity),a.path("collection/check")},cacheLabel:function(e){return"缓存"},style:function(e){return e.enabled?"btn btn-warn btn-flat btn-sm":"btn btn-success btn-flat btn-sm"},label:function(e){return e.enabled?"禁用":"启用"}},c='<div style="text-align: left"><div class="btn-group" ng-disabled="getExternalScopes().requesting"> <button ng-click="getExternalScopes().edit(row)" class="btn btn-default btn-flat btn-sm">编辑</button> <button ng-click="getExternalScopes().cache(row)" class="btn btn-default btn-flat btn-sm">{{ getExternalScopes().cacheLabel(row) }}</button> <button ng-click="getExternalScopes().check(row)" class="btn btn-default btn-flat btn-sm">检查</button> <button ng-class="getExternalScopes().style(row)">{{ getExternalScopes().label(row) }}</button> </div></div>',r.gridOptions={enableSorting:!1,columnDefs:[{name:"名称",field:"name",enableSorting:!1},{name:"绎者",field:"author_name",width:88,enableSorting:!1},{name:"大小",field:"size",width:99,enableSorting:!1},{name:"时长",field:"duration",width:99,enableSorting:!1},{name:"总长",field:"length",width:88,enableSorting:!1},{name:"已存",field:"cached",width:88,enableSorting:!1},{name:"状态",field:"cache_status",width:88,enableSorting:!1},{name:"操作",field:"created_at",width:200,enableSorting:!1,cellTemplate:c}],onRegisterApi:function(e){return r.gridApi=e}},r.getData=function(){var s;if(r.requesting)return;return r.requesting=!0,s=r.filter.value==="所有"?"":r.filter.value,i.get("/m/collections",{params:{page:r.page,pageSize:r.pageSize,keywords:r.keywords,filter:s}}).success(function(i){return e.group("collection"),e.log("GotCollections",i),e.groupEnd(),r.requesting=!1,i.err?t.log(i.err):(r.count=i.count,i.result&&i.result.forEach(function(e){return e.size=bytesToSize(e.size),e.duration&&(e.duration=getTime(e.duration)),e.created_at=n(e.creatd_at).format("YYYY-MM-DD")}),r.gridOptions.data=i.result)}).error(function(e){r.requesting=!1;if(e)return t.log(e)})},r.getData(),e.groupEnd()}})}).call(this);